<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119008715-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-119008715-1');
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        * { font-weight: 100; }
        h1 { font-weight: 100; }
        #graph-container { top: 0; bottom: 0; left: 0; right: 0; position: fixed; }
        .nn-picker { width: 440px; margin: 30px; z-index: 1000; }
        .card-header { background: #111827; color: #e5e7eb; }
        .card { border: 1px solid #111827; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: #2563eb; border-color: #2563eb; }
        .btn-secondary { background: #374151; border-color: #374151; }
        a, .nav-link { color: #93c5fd; }
        a:hover, .nav-link:hover { color: #60a5fa; }
        [data-toggle="collapse"] .fa:before { font-size: 2rem; color: #e5e7eb; content: "\f106"; position: relative; top: 5px; }
        .fa { transition: 0.3s transform ease-in-out; }
        .collapsed .fa { transform: rotate(-180deg); }
        .tab-content { padding: 20px; }
        input[type="range"] { margin-left: 10px; }
        #count { position: fixed; bottom: 0; right: 1rem; opacity: 0.4; font-weight: 100; color: #111827; }
        .text { font-weight: 300; }
        small.helper { color: #9ca3af; }
        label { color: #111827; }
    </style>

    <title>NN SVG - Varun</title>
</head>
<body style="background:#f3f4f6;">
    <div id="graph-container"></div>

    <div class="container-fluid">
        <div class="row">
            <div class="nn-picker">
                <div class="card">
                    <div class="card-header">
                        <a class="pull-right" data-toggle="collapse" href="#collapsable" role="button"><i class="fa"></i></a>
                        <h1>NN-SVG (Varun)</h1>
                        <p>Publication-ready NN-architecture schematics. <a id="download" href="#">Download SVG</a> · <a id="downloadPng" href="#">Download PNG</a> · <a id="downloadJpg" href="#">Download JPEG</a> · <a id="exportCode" href="#">Export Code</a></p>
                        <nav>
                            <div class="nav nav-tabs card-header-tabs" role="tablist">
                                <a class="nav-item nav-link" href="index.html" target="_blank">FCNN style</a>
                                <a class="nav-item nav-link" href="LeNet.html" target="_blank">LeNet style</a>
                                <a class="nav-item nav-link" href="AlexNet.html" target="_blank">AlexNet style</a>
                                <a class="nav-item nav-link active">Varun style</a>
                            </div>
                        </nav>
                    </div>
                    <div class="tab-content collapse show" id="collapsable">
                        <div class="tab-pane fade show active" id="FCNN" role="tabpanel">
                            <h4>Style:</h4>
                            <small class="helper">Tip: Drag nodes to reposition; links update live.</small>
                            <hr>
                            <div>
                                <input type="checkbox" id="edgeWidthProportional"><label for="edgeWidthProportional"> Edge width proportional to edge weights</label>
                            </div>
                            <div>
                                <label for="edgeWidth">Edge Width</label>
                                <input type="range" id="edgeWidth" min="0" max="2" step="0.01" value="0.5" style="position: relative; top: 3px;">
                            </div>
                            <hr>
                            <div>
                                <input type="checkbox" id="edgeOpacityProportional"><label for="edgeOpacityProportional"> Edge opacity proportional to edge weights</label>
                            </div>
                            <div>
                                <label for="edgeOpacity">Edge Opacity</label>
                                <input type="range" id="edgeOpacity" min="0" max="1" step="0.01" value="1" style="position: relative; top: 3px;">
                            </div>
                            <hr>
                            <div>
                                <input type="checkbox" id="edgeColorProportional"><label for="edgeColorProportional"> Edge color proportional to edge weights</label>
                            </div>
                            <div>
                                <input type="color" value="#0000ff" id="negativeEdgeColor">
                                <label for="negativeEdgeColor">Negative Edge Color</label>
                            </div>
                            <div>
                                <input type="color" value="#ff0000" id="positiveEdgeColor">
                                <label for="positiveEdgeColor">Positive Edge Color</label>
                            </div>
                            <div>
                                <input type="color" value="#505050" id="defaultEdgeColor">
                                <label for="defaultEdgeColor">Default Edge Color</label>
                            </div>
                            <hr>
                            <div>
                                <input type="checkbox" id="bezierCurves"><label for="bezierCurves"> Use Bezier Curves</label>
                            </div>
                            <hr>
                            <div class="mb-2">
                                <input type="checkbox" id="layerColoring"><label for="layerColoring"> Layer-wise coloring</label>
                            </div>
                            <div class="mb-2">
                                <label for="paletteName" class="mr-2">Palette</label>
                                <select id="paletteName" class="custom-select" style="width:auto; display:inline-block;">
                                    <option value="default">Default</option>
                                    <option value="colorblind">Colorblind</option>
                                    <option value="warm">Warm</option>
                                    <option value="cool">Cool</option>
                                    <option value="pastel">Pastel</option>
                                    <option value="viridis">Viridis</option>
                                </select>
                            </div>
                            <div>
                                <input type="checkbox" id="highContrast"><label for="highContrast"> High-contrast mode</label>
                            </div>
                            <div>
                                <label for="labelFontSize">Label Font Size</label>
                                <input type="range" id="labelFontSize" min="8" max="32" step="1" value="12" style="position: relative; top: 3px;">
                            </div>
                            <div class="mt-2">
                                <label for="orientation">Orientation</label>
                                <select id="orientation" class="custom-select" style="width:auto; display:inline-block;">
                                    <option value="right">Left → Right</option>
                                    <option value="left">Right → Left</option>
                                    <option value="up">Bottom → Top</option>
                                    <option value="down">Top → Bottom</option>
                                </select>
                            </div>
                            <hr>
                            <div>
                                <label for="nodeDiameter">Node Diameter</label>
                                <input type="range" id="nodeDiameter" min="10" max="50" step="1" value="20" style="position: relative; top: 3px;">
                            </div>
                            <div>
                                <input type="color" value="#ffffff" id="nodeColor">
                                <label for="nodeColor">Node Color</label>
                            </div>
                            <div>
                                <input type="color" value="#333333" id="nodeBorderColor">
                                <label for="nodeBorderColor">Node Border Color</label>
                            </div>
                            <hr>
                            <div>
                                <label for="betweenLayers">Layer Spacing</label>
                                <input type="range" id="betweenLayers" min="30" max="400" step="1" value="160" style="position: relative; top: 3px;">
                            </div>
                            <div>
                                <input type="checkbox" id="showBias"><label for="showBias"> Show Bias Units</label>
                            </div>
                            <div>
                                <input type="checkbox" id="showLabels" checked><label for="showLabels"> Show Layer Labels</label>
                            </div>
                            <div id="arrowhead">
                                <input type="checkbox" id="showArrowheads"><label for="showArrowheads"> Show Arrowheads</label>
                                <div class="form-check form-check-inline ml-3">
                                    <label class="form-check-label">
                                        <input class="form-check-input" type="radio" name="arrowheadStyle" id="empty" value="empty" checked> empty
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <label class="form-check-label">
                                        <input class="form-check-input" type="radio" name="arrowheadStyle" id="solid" value="solid"> solid
                                    </label>
                                </div>
                            </div>

                            <hr>
                            <h4>Architecture:</h4>
                            <div class="mb-2">
                                <label for="presetSelect" class="mr-2">Presets</label>
                                <select id="presetSelect" class="custom-select" style="width:auto; display:inline-block;">
                                    <option value="custom">Custom</option>
                                    <option value="mlp">MLP: 16-12-10-1</option>
                                    <option value="deep">Deep: 32-32-32-32-10</option>
                                    <option value="residual">Residual MLP: 16-16-16-1 (skip 0->2)</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="skipConnections" class="mr-2">Skip Connections</label>
                                <input type="text" id="skipConnections" class="form-control" placeholder="e.g., 0->2, 1->3">
                                <small class="helper">Format: comma-separated pairs layerIndex->layerIndex. Adds dense residual/skip edges.</small>
                            </div>
                            <hr>
                            <div id="architecture">
                                <div class="row entry">
                                    <div class="input-group mb-2 mr-sm-2 col-4">
                                        <button class="btn btn-secondary btn-remove input-group-prepend"><span class="fa fa-minus"></span></button>
                                        <input type="number" class="form-control" name="numberOfNodes" step="1" value="16" />
                                    </div>
                                    <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">
                                </div>
                                <div class="row entry">
                                    <div class="input-group mb-2 mr-sm-2 col-4">
                                        <button class="btn btn-secondary btn-remove input-group-prepend"><span class="fa fa-minus"></span></button>
                                        <input type="number" class="form-control" name="numberOfNodes" step="1" value="12" />
                                    </div>
                                    <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">
                                </div>
                                <div class="row entry">
                                    <div class="input-group mb-2 mr-sm-2 col-4">
                                        <button class="btn btn-secondary btn-remove input-group-prepend"><span class="fa fa-minus"></span></button>
                                        <input type="number" class="form-control" name="numberOfNodes" step="1" value="10" />
                                    </div>
                                    <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">
                                </div>
                                <div class="row entry">
                                    <div class="input-group mb-2 mr-sm-2 col-4">
                                        <button class="btn btn-secondary btn-remove input-group-prepend"><span class="fa fa-minus"></span></button>
                                        <input type="number" class="form-control" name="numberOfNodes" step="1" value="1" />
                                    </div>
                                    <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">
                                </div>
                                <div class="row entry">
                                    <div class="input-group mb-2 mr-sm-2 col-4">
                                        <button class="btn btn-primary btn-add input-group-prepend"><span class="fa fa-plus"></span></button>
                                        <input type="number" class="form-control" name="numberOfNodes" step="1"/>
                                    </div>
                                    <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">
                                </div>
                            </div>
                            <hr>
                            <div class="mb-2">
                                <input type="checkbox" id="addBatchNorm"><label for="addBatchNorm"> Add BatchNorm1d after Linear layers (code export)</label>
                            </div>
                            <div class="mb-2">
                                <label for="dropoutP">Dropout p (code export)</label>
                                <input type="number" id="dropoutP" class="form-control" min="0" max="1" step="0.05" value="0">
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" id="newRandomWeights">New Random Weights</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="count"><span></span><a style="font-size: 1rem" href="about.html">About</a></div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="util.js"></script>
    <script src="FCNN.js?v=3"></script>

    <script>
varun = FCNN();

function parseSkipConnections() {
    var raw = ($('#skipConnections').val() || '').trim();
    if (!raw) { return []; }
    try {
        return raw.split(',').map(s => s.trim()).filter(s => s.includes('->')).map(pair => {
            var parts = pair.split('->').map(t => parseInt(t.trim()));
            if (isNaN(parts[0]) || isNaN(parts[1])) { return null; }
            return [parts[0], parts[1]];
        }).filter(Boolean);
    } catch (e) { return []; }
}

function applyPreset(name) {
    if (name === 'mlp') {
        $('#architecture .entry').remove();
        var layers = [16,12,10,1];
        layers.forEach((n,i) => {
            var row = $('<div class="row entry">\n  <div class="input-group mb-2 mr-sm-2 col-4">\n    <button class="btn btn-'+(i===layers.length-1?'primary btn-add':'secondary btn-remove')+' input-group-prepend"><span class="fa fa-'+(i===layers.length-1?'plus':'minus')+'"></span></button>\n    <input type="number" class="form-control" name="numberOfNodes" step="1" value="'+n+'" />\n  </div>\n  <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">\n</div>');
            $('#architecture').append(row);
        });
        $('#skipConnections').val('');
    } else if (name === 'deep') {
        $('#architecture .entry').remove();
        var layers = [32,32,32,32,10];
        layers.forEach((n,i) => {
            var row = $('<div class="row entry">\n  <div class="input-group mb-2 mr-sm-2 col-4">\n    <button class="btn btn-'+(i===layers.length-1?'primary btn-add':'secondary btn-remove')+' input-group-prepend"><span class="fa fa-'+(i===layers.length-1?'plus':'minus')+'"></span></button>\n    <input type="number" class="form-control" name="numberOfNodes" step="1" value="'+n+'" />\n  </div>\n  <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="16" style="position: relative; top: -4px;">\n</div>');
            $('#architecture').append(row);
        });
        $('#skipConnections').val('');
    } else if (name === 'residual') {
        $('#architecture .entry').remove();
        var layers = [16,16,16,1];
        layers.forEach((n,i) => {
            var row = $('<div class="row entry">\n  <div class="input-group mb-2 mr-sm-2 col-4">\n    <button class="btn btn-'+(i===layers.length-1?'primary btn-add':'secondary btn-remove')+' input-group-prepend"><span class="fa fa-'+(i===layers.length-1?'plus':'minus')+'"></span></button>\n    <input type="number" class="form-control" name="numberOfNodes" step="1" value="'+n+'" />\n  </div>\n  <input type="range" class="form-control col-4" name="betweenNodesInLayer" min="0" max="100" step="1" value="20" style="position: relative; top: -4px;">\n</div>');
            $('#architecture').append(row);
        });
        $('#skipConnections').val('0->2');
    }
    restart();
}

function restart() {
    var layers = $('#architecture').find('input[name="numberOfNodes"]').map((i,el) => $(el).val()).get().filter(input => $.isNumeric(input)).map(s => parseInt(s));
    var spacing = $('#architecture').find('input[name="betweenNodesInLayer"]').map((i,el) => parseFloat($(el).val())).get();
    var skips = parseSkipConnections();
    varun.redraw({'architecture_':layers, 'skipConnections_': skips});
    varun.redistribute({'betweenNodesInLayer_':spacing});
    $('#count span:first').text(varun.graph.nodes.length+" nodes, "+varun.graph.links.length+" edges you don't need to draw yourself! ")
}

restart();

$("#edgeWidthProportional").change(function(){ varun.style({'edgeWidthProportional_': this.checked}) });
$("#edgeWidth").change(function(){ varun.style({'edgeWidth_': parseFloat(this.value)}) });
$("#edgeOpacityProportional").change(function(){ varun.style({'edgeOpacityProportional_': this.checked}); $("#edgeOpacity").prop('disabled', this.checked); });
$("#edgeOpacity").change(function(){ varun.style({'edgeOpacity_': parseFloat(this.value)}) });
$("#negativeEdgeColor").change(function(){ varun.style({'negativeEdgeColor_': this.value}) });
$("#positiveEdgeColor").change(function(){ varun.style({'positiveEdgeColor_': this.value}) });
$("#edgeColorProportional").change(function(){ varun.style({'edgeColorProportional_': this.checked}) });
$("#defaultEdgeColor").change(function(){ varun.style({'defaultEdgeColor_': this.value}) });
$("#nodeDiameter").change(function(){ varun.style({'nodeDiameter_': parseFloat(this.value)}) });
$("#nodeColor").change(function(){ varun.style({'nodeColor_': this.value}) });
$("#nodeBorderColor").change(function(){ varun.style({'nodeBorderColor_': this.value}) });
$("#betweenLayers").change(function(){ varun.redistribute({'betweenLayers_': parseFloat(this.value)}) });
$("#orientation").change(function(){ varun.redistribute({'nnDirection_': this.value}) });
$("#showBias").change(function(){ varun.redraw({'showBias_': this.checked}); varun.redistribute(); });
$("#showLabels").change(function(){ varun.redraw({'showLabels_': this.checked}) });
$("#showArrowheads").change(function(){ varun.style({'showArrowheads_': this.checked}) });
$("#arrowhead input:radio").change(function(){ varun.style({'arrowheadStyle_': this.value}) });
$("#bezierCurves").change(function(){ varun.redistribute({'bezierCurves_': this.checked}) });
$("#layerColoring").change(function(){ varun.style({'layerColoring_': this.checked}) });
$("#paletteName").change(function(){ $('#layerColoring').prop('checked', true); varun.style({'layerColoring_': true, 'paletteName_': this.value}) });
$("#highContrast").change(function(){ varun.style({'highContrast_': this.checked}) });
$("#labelFontSize").change(function(){ varun.style({'nominal_text_size_': parseInt(this.value, 10)}) });

$(document).on('click', '.btn-add', function(e){ e.preventDefault(); var controlForm = $('#architecture'); var currentEntry = $(this).parents('.entry:first'); var newEntry = $(currentEntry.clone()).appendTo(controlForm); newEntry.find('input[name="numberOfNodes"]').val(''); controlForm.find('.entry:not(:last) .btn-add').removeClass('btn-add').addClass('btn-remove').removeClass('btn-primary').addClass('btn-secondary').html('<span class="fa fa-minus"></span>'); restart(); });
$(document).on('click', '.btn-remove', function(e){ e.preventDefault(); $(this).parents('.entry:first').remove(); restart(); return false; });
$(document).on('change', "input[name='numberOfNodes']", restart);
$(document).on('change', "input[name='betweenNodesInLayer']", restart);
$(document).on('input', '#skipConnections', restart);
$('#presetSelect').change(function(){ applyPreset(this.value); });
$(document).on('click', '#newRandomWeights', function(){ link = varun.link.data([]); varun.link.exit().remove(); restart(); });

function downloadDataUrl(dataUrl, filename) { var a = document.createElement('a'); a.href = dataUrl; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
function svgToDataUrl(svgEl, bgColor, mime) { var svg = svgEl.cloneNode(true); svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg'); var svgData = new XMLSerializer().serializeToString(svg); var svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'}); var url = URL.createObjectURL(svgBlob); return new Promise(function(resolve){ var img = new Image(); img.onload = function(){ var canvas = document.createElement('canvas'); canvas.width = svgEl.getBoundingClientRect().width || window.innerWidth; canvas.height = svgEl.getBoundingClientRect().height || window.innerHeight; var ctx = canvas.getContext('2d'); if (bgColor) { ctx.fillStyle = bgColor; ctx.fillRect(0,0,canvas.width, canvas.height); } ctx.drawImage(img, 0, 0); URL.revokeObjectURL(url); resolve(canvas.toDataURL(mime || 'image/png')); }; img.src = url; }); }
function downloadRaster(mime, filename) { var container = document.getElementById('graph-container'); var svg = container.querySelector('svg'); var canvas = container.querySelector('canvas'); if (canvas) { try { downloadDataUrl(canvas.toDataURL(mime), filename); } catch (e) {} return; } if (svg) { svgToDataUrl(svg, '#ffffff', mime).then(function(dataUrl){ downloadDataUrl(dataUrl, filename); }); } }
$('#download').on('click', function(){ $(this).attr("href", 'data:application/octet-stream;base64,' + btoa(unescape(encodeURIComponent(d3.select("#graph-container").html())))).attr("download", "nn.svg") });
$('#downloadPng').on('click', function(e){ e.preventDefault(); downloadRaster('image/png', 'varun.png'); });
$('#downloadJpg').on('click', function(e){ e.preventDefault(); downloadRaster('image/jpeg', 'varun.jpg'); });

function generatePytorchCode(layers, addBn, dropoutP) { var code = []; code.push("import torch"); code.push("import torch.nn as nn"); code.push(""); code.push("class Model(nn.Module):"); code.push("    def __init__(self):"); code.push("        super().__init__()"); code.push("        self.net = nn.Sequential("); for (var i = 0; i < layers.length - 1; i++) { code.push("            nn.Linear("+layers[i]+", "+layers[i+1]+"),"); if (addBn && i < layers.length - 2) { code.push("            nn.BatchNorm1d("+layers[i+1]+"),"); } if (i < layers.length - 2) { code.push("            nn.ReLU(inplace=True),"); } if (dropoutP > 0 && i < layers.length - 2) { code.push("            nn.Dropout(p="+dropoutP+"),"); } } code.push("        )"); code.push(""); code.push("    def forward(self, x):"); code.push("        return self.net(x)"); return code.join("\n"); }
$('#exportCode').on('click', function(e){ e.preventDefault(); var layers = $('#architecture').find('input[name="numberOfNodes"]').map((i,el) => $(el).val()).get().filter(input => $.isNumeric(input)).map(s => parseInt(s)); if (layers.length < 2) { return; } var addBn = $('#addBatchNorm').is(':checked'); var p = parseFloat($('#dropoutP').val() || '0') || 0; var code = generatePytorchCode(layers, addBn, p); var blob = new Blob([code], {type: 'text/x-python'}); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'model.py'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
    </script>
</body>
</html>
